# 1.2  如何阅读此书

在本书中，我们展示了重要的代码阅读技巧，并以实践中出现的形式概述了常见的编程概念，努力提高您的代码阅读能力。 尽管您会在接下来的章节中发现许多重要的计算机科学和计算实践概念的讨论，例如数据和控制结构、编码标准和软件架构，但它们的处理必然是粗略的，因为本书的目的是让您检查 在生产代码的上下文中使用这些想法，而不是介绍这些想法本身。 我们按照一定的顺序排列了这些材料，以便您从基本的元素逐步发展到更复杂的元素。 不过，这本书是一本读物，而不是一本侦探小说，所以请随意按照适合您兴趣的顺序阅读。

## 1.2.1 印刷惯例

所有代码清单和对程序元素的文本引用（例如，函数名称、关键字、运算符）均以打字机字体设置。 我们的一些示例涉及在 Unix 或 Windows shell 中执行的命令序列。 我们显示 shell 命令提示符 $ 来表示 Unix shell 命令和 DOS 命令提示符

图1.1 带注释的列表示例

C:\> 表示 Windows 控制台提示符。 Unix shell 命令可以跨越多行； 我们使用 > 作为续线符号。
```
$ grep -l malloc *.c | > wc -l
8
C:\>grep -l malloc *.c | wc -l
8
```

显示提示和续行符号只是为了区分您的输入和系统输出； 您只需在提示后键入命令即可。

图

在某些地方，我们讨论不安全的编码实践或常见陷阱。 它们的边缘带有危险符号。 在进行代码演练或只是阅读代码以查找错误时，您应该警惕此类代码。 边距上标有 i 的文本标识了常见的编码习惯。 当我们阅读文本时，我们倾向于识别整个单词而不是字母。 同样，识别代码中的这些习语将使您能够更快、更有效地阅读代码，并在更高层次上理解程序。

本书中使用的代码示例来自现实世界的程序。 我们在脚注中标识了我们使用的程序（例如[3]图1.1中出现的程序），给出了该程序在本书配套源代码的目录树中的精确位置以及特定片段所覆盖的行号。 当图包含不同源代码文件的一部分时（如图 5.17，[4]第 169 页所示），脚注将指示这些文件所在的目录。

[3]netbsdsrc/usr.bin/yes/yes.c:53-64
[4]netbsdsrc/distrib/utils/more

有时我们会省略列出的代码中的某些部分； 我们用省略号 [...] 来表示。 在这些情况下，行号代表所列出的代码涵盖的整个范围。 在参考原始代码时，您可能会注意到的其他更改包括大多数 C 声明从旧的“Kernighan 和 Ritchie”样式更改为 ANSI C，以及省略了一些注释、空格和程序许可信息。 我们希望这些更改能够增强我们提供的示例的可读性，而不会过度影响原始示例的真实性。 使用定制的软件应用程序以图形方式对重要的代码示例进行注释。 使用注释软件可确保示例保持正确并且可以进行机器验证。 有时我们会在叙述文本中扩展注释。 在这些情况下（图 1.1:1），注释以打印在框中的数字开头； 冒号后面的相同数字用于引用文本中的注释。

## 1.2.2 图表

我们选择 UML 作为我们的设计图，因为它是事实上的行业标准。 在准备本书的过程中，我们发现开发[5]一种用于生成 UML 图的开源声明性语言很有用，并且我们还对底层 GraphViz 工具的代码库[6]做了一些小的改进。 我们希望您发现生成的 UML 图可以帮助您更好地理解我们分析的代码。

[5]http://www.spinellis.gr/sw/umlgraph
[6]http://www.graphviz.org

图 1.2 显示了我们在图表中使用的符号示例。 请记住以下几点。

- 我们使用 UML 的活动类表示法来绘制流程（例如，过滤器式程序）：带有粗体框的类框（例如，参见第 213 页的图 6.14）。
- 我们使用关联导航关系来描述数据元素之间的指针：带有空心箭头的实线。 我们还将每个数据结构分为水平或垂直部分，以更好地描述其内部组织（例如，参见第 121 页图 4.10）。
- 我们用位于关联线上的实线箭头来显示关联的方向（例如，为了说明数据流），而不是按照 UML 的规定位于其顶部（例如，参见第 274 页的图 9.3）。

图 1.2 基于UML的图符号

全部其它使用标准UML符号的关系。

- 类继承是使用泛化关系绘制的：带有空箭头的实线（例如，参见图 9.6，第 277 页）。
- 接口实现被绘制为实现关系：带有空箭头的虚线（例如，参见图 9.7，第 278 页）。
- 两个元素之间的依赖关系（例如，构建过程的文件之间）用虚线和空心箭头显示（例如，参见图 6.8，第 191 页）。
- 组合（例如，由各种模块组成的库）通过聚合关联来描述：一条以菱形形状结尾的线（例如，参见图 9.24，第 321 页）。

## 1.2.3 练习

您将在大多数部分末尾找到的练习旨在激励您应用我们描述的技术并进一步研究特别有趣的问题，或者它们可能是深入讨论的起点。 在大多数情况下，您可以交替使用对本书 CD-ROM 的引用和“在您的环境中编码”。 重要的是阅读和检查来自现实世界的重要系统的代码。 如果您当前正在开发这样的系统（无论是专有开发工作还是开源项目），那么针对该系统而不是本书的 CD-ROM 进行代码阅读练习会更有成效。

许多练习首先要求您找到特定的代码序列。 该任务可以自动化。 首先，将您要查找的代码表达为正则表达式。 （请阅读第 10 章中有关正则表达式的更多信息。）然后，在 Unix 环境中使用如下命令搜索代码库：

```
find /cdrom -name '*.c' -print | xargs grep 'malloc.*NULL'
```

或者在 Windows 环境中使用 Perl 脚本 codefind.pl。（源代码库中的某些文件与旧的 MS-DOS 设备具有相同的名称，导致某些 Windows 实现在尝试访问它们时挂起；Perl 脚本明确 围绕这个问题的代码。）

tools/codefind.pl

## 1.2.4 补充材料

您在本书中找到的所有示例都基于现有的开源软件代码。 源代码库包含超过 53,000 个文件，占用超过 540 MB。 对代码示例的所有引用都在脚注中明确标识，因此您可以在其上下文中检查引用的代码。 此外，您可以通过三种不同的方式协调对源代码库的探索与本书的文本。

- 您可以在 Index 中查找每个引用的源文件的文件名（完整文件路径的最后一个组成部分）。
- 您可以浏览附录 A，其中提供了源代码库的概述。
- 您可以搜索附录C，其中包含按照代码目录结构排序的引用源代码文件列表。

## 1.2.5 工具

我们提供的一些示例取决于 Unix 类型操作系统下找到的程序的可用性，例如 grep 和 find。 许多此类系统（例如，FreeBSD、GNU/Linux、NetBSD、OpenBSD 和 Solaris）现在可以免费下载并安装在各种硬件上。 如果您无法访问此类系统，您仍然可以通过使用针对其他操作系统（例如 Windows）的端口从这些工具中受益。 （第 10.9 节包含有关工具可用性的更多详细信息。）

## 1.2.6 大纲

在第 2 章中，我们将介绍两个完整的程序，并逐步检查它们的工作原理。 在此过程中，我们概述了一些基本的
 
代码阅读策略并识别常见的 C 控制结构、构建块、习惯用法和陷阱。 我们将一些更高级（且容易被滥用）的 C 语言元素在第 3 章和第 5 章中讨论。第 4 章研究如何阅读包含常见数据结构的代码。 第 6 章讨论真正大型项目中的代码：地理上分散的团队工作，包括数千个文件和数百万行代码。 大型项目通常采用通用的编码标准和约定（第 7 章中讨论），并且可能包括正式文档（第 8 章中介绍）。 第9章提供了查看森林而不是树木的背景信息和建议：系统的体系结构而不是其代码细节。 阅读代码时，您可以使用许多工具。 这些是第 10 章的主题。最后，第 11 章包含一个完整的示例：本书其余部分中介绍的代码阅读和代码理解技术用于从月球算法中定位和提取月相算法。 NetBSD 源代码库并将其作为 SQL 函数添加到基于 Java 的 HSQL 数据库引擎中。

以附录的形式，您将找到我们在示例中使用的以及本书附带的代码的概述（附录 A）、其代码出现在本书正文 A（附录 B）中的个人和组织的列表、 所有引用的源文件按其所在目录排序（附录 C）、源代码许可证（附录 D）以及阅读代码的格言列表以及每个格言的介绍页面（附录 E）。

## 1.2.7 主流语言排名

书中的大多数示例都基于在 POSIX 字符终端环境上运行的 C 程序。 这种选择背后的原因与开源软件可移植 C 代码的丰富性以及我们发现的示例与用 C++ 或 Java 编写的类似示例相比的简洁性有关。 （这种现象背后的原因可能主要与代码的年龄或流行的编码风格有关，而不是特定的语言特征。）不幸的是，基于图形用户界面（GUI）的程序在我们的样本中表现不佳，但阅读和推理 关于此类程序确实值得单独出一本书。 在我们提到 Microsoft Windows API 函数的所有情况下，我们指的是 Win32SDK API 而不是 .NET 平台。

表 1.1. 开源项目中最常用的十种语言

我们多次被问及用于编写开源软件的语言。 表 1.1 总结了项目数量 [8]

使用 SourceForge.net 存储库中最常用的十种语言中的每一种。 C 语言位居榜首，但可能代表性不足，因为许多非常大的 C 开源项目（例如 FreeBSD 和 GNU/Linux）都是独立托管的，而且许多声称使用 C++ 的项目实际上是用 C 编写的，这使得 很少使用 C++ 功能。 另一方面，请记住，为非开源项目编译的类似列表将完全不同，可能会在列表顶部包含 COBOL、Ada、Fortran 和各种 4GL。 此外，如果您正在维护代码（这很可能是阅读代码的一个不流行的原因），那么您将阅读的语言很可能在五年或十年前就已被采用（如果您幸运的话），反映了那个时代的编程语言景观 。

[8]https://sourceforge.net/softwaremap/trove_list.php/?form_cat=160/

我们的示例所代表的代码结构在大多数情况下同样适用于 Java 和 C++ 程序； 许多也适用于 Perl、Python 和 PHP。 但是，您可以安全地跳过

- 第 3 章，如果您从未遇到过 C（或 C++ 作为更好的 C）代码 - - 第 9.3.4 节，如果 C++ 和 Ada 不是您的菜
- 第 9.1.3 节，如果您已设法避免使用面向对象方法、C++、Java、Python、Smalltalk 以及 Perl 的面向对象功能
- 如果您不熟悉 Java 或 C++，请参阅第 5.2 节
- 如果您是结构化编程狂热者或忠实的 Java 粉丝，请参阅第 2.8 节


