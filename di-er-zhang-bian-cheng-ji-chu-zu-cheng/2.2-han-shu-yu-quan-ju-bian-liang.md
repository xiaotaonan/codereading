# 2.2  函数与全局变量

程序 Expand 通过将硬制表符（\t、ASCII 字符 9）扩展为多个空格来处理以其参数命名的文件（如果未指定文件参数，则处理其标准输入）。 默认行为是每八个字符设置制表位； 这可以被使用 -t 选项指定的逗号或空格分隔的数字列表覆盖。 该程序实现的一个有趣的方面，以及我们检查它的原因，是它使用了 C 系列 [10] 语言中可用的所有控制流语句。 图2.2包含expand的变量和函数声明，[12]图2.5（第2.5节）包含使用的两个补充函数。

[10]netbsdsrc/usr.bin/expand/expand.c:36–62

[11]netbsdsrc/usr.bin/expand/expand.c:64–151

[12]netbsdsrc/usr.bin/expand/expand.c:153–185

在检查一个重要的程序时，首先确定其主要组成部分是很有用的。 在我们的例子中，这些是全局变量（图2.2:1）和函数main（图2.3）、getstops（见图2.5:1）和usage（见图2.5:8）。

整型变量 nstops 和整型stabstops 数组被声明为全局变量，位于功能块范围之外。 因此，它们对于我们正在检查的文件中的所有函数都是可见的。

接下来的三个函数声明（图 2.2:2）声明了稍后将出现在文件中的函数。 由于其中一些函数在定义之前就已使用，因此在 C/C++ 程序中，声明允许编译器验证传递给函数的参数及其返回值，并生成正确的相应代码。 当没有给出前向声明时，C编译器将在第一次使用函数时对函数返回类型和参数进行假设； C++ 编译器会将此类情况标记为错误。 如果以下函数定义与这些假设不匹配，编译器将发出警告或错误消息。 但是，如果为另一个文件中定义的函数提供了错误的声明，则程序可能会正常编译，但在运行时会失败。

图 2.2 展开制表位（声明）。

```
#include <sys/cdefs.h>
#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <unistd.h>

【1】
int nstops;
int tabstops[100];

【2】
static void getstops(char *);
int main(int,char *);
static void usage(void);
```

(a)头文件

【1】全局参数

【2】前向函数声明

请注意这两个函数是如何声明为静态的，而变量却不是。 这意味着这两个函数仅在文件内可见，而变量可能对组成程序的所有文件可见。 由于 Expand 仅包含单个文件，因此这种区别在我们的例子中并不重要。 大多数组合已编译 C 文件的链接器都相当原始； 对所有程序文件可见的变量（即未声明为静态的变量）可以以令人惊讶的方式与其他文件中定义的同名变量进行交互。 因此，在检查代码时确保将单个文件中所需的所有变量都声明为静态是一个很好的做法。



